# ????? ?????? ????? (DB ? API ? UI)

## ?????? ? ?????????
- `Questionnaire` (`questionnaires`): ?????? ? ?????????? ???????.
- `Pair` (`pairs`): ????, `members` ? Discord IDs.
- `PairQuestionnaireSession` (`pair_qn_sessions`): ?????? ??????????? ?????? ??????.
- `PairQuestionnaireAnswer` (`pair_qn_answers`): ?????? ?? ???????? (A/B).

## 1) ???????? ????????
**UI ? API**
- `GET /api/questionnaires/cards`
- Auth: httpOnly cookie `session` (JWT)

**API ? DB**
- `Questionnaire.aggregate()` ? `questionCount = $size(questions)`
- `Pair.findOne({ members: userId, status: 'active' })`
- `PairQuestionnaireSession.find({ pairId, status: in_progress|completed })`
- `PairQuestionnaireAnswer.aggregate()` ?? sessionId + by

**DTO ? UI**
- UI ???????? `QuestionnaireCardDTO[]`, ?? ??????? ??????? ??????????????.

## 2) Start/Resume ??????
**UI ? API**
- `POST /api/pairs/:id/questionnaires/:qid/start`

**API ? DB**
- ???????? ????
- ????? ???????????? `in_progress` ??????
- ???????? ????? `PairQuestionnaireSession`

## 3) ?????????? ???????
**UI ? API**
- `POST /api/pairs/:id/questionnaires/:qid/answer`

**API ? DB**
- ????? ???????? ??????
- ?????? `PairQuestionnaireAnswer` (sessionId, questionId, by, ui)

## 4) ???????? ? ??????????
- ???????? ????????? ?? ?????????? `questionId` ? ?????? `sessionId` ? `by`.
- ?????? `completed` ??????? ?? `PairQuestionnaireSession.status`.

## Evidence (path:line)
- `Questionnaire`: `src/models/Questionnaire.ts:23,33,51-62`
- `Pair.members`: `src/models/Pair.ts:16,51`
- `PairQuestionnaireSession`: `src/models/PairQuestionnaireSession.ts:4-22`
- `PairQuestionnaireAnswer`: `src/models/PairQuestionnaireAnswer.ts:4-21`
- Start session: `src/app/api/pairs/[id]/questionnaires/[qid]/start/route.ts:30-47`
- Answer write: `src/app/api/pairs/[id]/questionnaires/[qid]/answer/route.ts:33-43`
- Cards endpoint: `src/app/api/questionnaires/cards/route.ts:109-190`

## ?????????
- Auth ?????????? ????? JWT ? httpOnly cookie `session`.
- `sub` ? JWT = Discord userId.
- `meta.isStarter` ????????????? ? `Questionnaire` ???????/????????.
- ???????: in_progress > completed > required > new; locked ??? ?????????? ????.

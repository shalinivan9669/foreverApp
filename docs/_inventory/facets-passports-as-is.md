# Facets & Passports — As-Is (MVP)

**Обзор**
- В `User.vectors` хранятся осевые уровни и списки `positives/negatives`; в profile-summary уровни приводятся к 0..100. Evidence: `src/models/User.ts:13-16` — `vectors: Record<string, {` / `level: number;`; `src/models/User.ts:71-73` — `level:     { type: Number, required: true, default: 0 },` / `positives: { type: [String], default: [] },`; `src/app/api/users/me/profile-summary/route.ts:69-81` — `// Уровни по 6 осям из user.vectors (0..100)` / `const levelsByAxis: Record<Axis, number> = {`; `src/app/api/users/me/profile-summary/route.ts:79-81` — `const lvl = Number(user.vectors?.[a]?.level ?? 0);` / `levelsByAxis[a] = Math.round(clamped * 100);`
- Match score считается как нормализованная дистанция между 6-осевыми векторами и отдаётся в `score: 0..100`. Evidence: `src/utils/calcMatch.ts:2-15` — `export function distance(a: number[], b: number[]) {` / `return Math.min(100, Math.max(0, raw));`; `src/app/api/match/feed/route.ts:18-25` — `const pickVec = (u: Pick<UserType, 'vectors'>): number[] => [` / `u.vectors.communication.level,`; `src/app/api/match/feed/route.ts:68-75` — `const s = score(distance(myVec, pickVec(u)));` / `score: s,`
- Pair passport хранится в `Pair.passport`, пересчитывается в `/api/pairs/[id]/diagnostics` и может быть создан при `/api/match/confirm` при пустом паспорте. Evidence: `src/models/Pair.ts:21-27` — `passport?: {` / `levelDelta:  { axis: string; delta: number }[];`; `src/app/api/pairs/[id]/diagnostics/route.ts:58-66` — `const passport = buildPassport(ua, ub);` / `return NextResponse.json({ pairId: id, passport: { ...passport, lastDiagnosticsAt } });`; `src/app/api/match/confirm/route.ts:129-136` — `const needPassport =` / `pair.passport = buildPassport(u, v);`

**Фасеты: as-is**
| Термин в коде | Где хранится | Тип/шкала | Есть ли уровни | Где применяется | Evidence (path:line + цитата ≤2 строки) |
|---|---|---|---|---|---|
| `Axis` (оси) | Type alias (UI), используется как ключи в `vectors`/`levelsByAxis` | enum-строки (6 осей) | Нет | UI: радар уровней; API: уровни профиля | `src/components/charts/AxisRadar.tsx:4` — `type Axis = 'communication'|'domestic'|'personalViews'|'finance'|'sexuality'|'psyche';`<br>`src/app/api/users/me/profile-summary/route.ts:69-71` — `// Уровни по 6 осям из user.vectors (0..100)` / `const levelsByAxis: Record<Axis, number> = {` |
| `vectors.*.level` | `User.vectors` (schema) | number; в profile-summary квантуется в % | Да: в profile-summary clamp 0..1 → 0..100 | Match feed (score), profile summary (levelsByAxis), diagnostics (buildPassport) | `src/models/User.ts:71` — `level:     { type: Number, required: true, default: 0 },`<br>`src/app/api/users/me/profile-summary/route.ts:79-81` — `const lvl = Number(user.vectors?.[a]?.level ?? 0);` / `levelsByAxis[a] = Math.round(clamped * 100);`<br>`src/app/api/match/feed/route.ts:68-71` — `const s = score(distance(myVec, pickVec(u)));` / `return {` |
| `vectors.*.positives` / `vectors.*.negatives` (facets/traits) | `User.vectors` (schema) | string[] | Нет | Profile summary (strongSides/growthAreas), pair diagnostics (passport) | `src/models/User.ts:72-73` — `positives: { type: [String], default: [] },` / `negatives: { type: [String], default: [] },`<br>`src/app/api/users/me/profile-summary/route.ts:88-91` — `const pos = user.vectors?.[a]?.positives?.length ?? 0;` / `if (pos >= 2) strongSides.push(a);`<br>`src/app/api/pairs/[id]/diagnostics/route.ts:25-29` — `const pp = inter(A.positives, B.positives);` / `const BcoversA = inter(B.positives, A.negatives);` |
| `Pair.passport.*.facets` | `Pair.passport` (schema) | string[] (facets) + `severity: 1|2|3` | Да: `riskZones.severity` | Diagnostics API; Pair profile UI | `src/models/Pair.ts:21-24` — `strongSides: { axis: string; facets: string[] }[];` / `riskZones:   { axis: string; facets: string[]; severity: 1|2|3 }[];`<br>`src/app/api/pairs/[id]/diagnostics/route.ts:31-33` — `if (nn.length || bothLow || delta > DELTA) {` / `const severity: 1|2|3 = delta > DELTA + 1 ? 3 : (bothLow || nn.length >= 2 ? 2 : 1);`<br>`src/app/pair/page.tsx:216-224` — `{(data.pair.passport?.strongSides ?? []).slice(0, 3).map((s, i) => (` / `{s.axis}: {s.facets.join(', ')}` |
| `calcMatch.score` / `distance` | `src/utils/calcMatch.ts` | score 0..100 (clamped) | Нет | Match feed scoring | `src/utils/calcMatch.ts:11-15` — `const raw  = 100 - (d / maxD) * 100;` / `return Math.min(100, Math.max(0, raw));`<br>`src/app/api/match/feed/route.ts:68-75` — `const s = score(distance(myVec, pickVec(u)));` / `score: s,` |

**User passport: as-is**
| Параметр (как в коде) | Источник (model field или вычисляется) | Где заполняется | Где используется | Evidence (path:line + цитата ≤2 строки) |
|---|---|---|---|---|
| `personal.gender/age/city/relationshipStatus` | `User.personal` | Onboarding step 1 → `POST /api/users` | Обновляется при создании пары (`relationshipStatus`) | `src/models/User.ts:7-12` — `personal: {` / `relationshipStatus: 'seeking' | 'in_relationship';`<br>`src/components/OnboardingWizard.tsx:43-55` — `body: JSON.stringify({` / `relationshipStatus: status,`<br>`src/app/api/match/confirm/route.ts:152-153` — `await User.updateMany({ id: { $in: members } },` / `{ $set: { 'personal.relationshipStatus': 'in_relationship' } });` |
| `vectors.*.level/positives/negatives` | `User.vectors` | `POST /api/users` или `PUT /api/users/[id]` (если `body.vectors`) | Match feed score; profile summary passport; pair diagnostics passport | `src/app/api/users/route.ts:15-16` — `if (body.vectors) updateFields.vectors = body.vectors;` / `if (body.preferences) updateFields.preferences = body.preferences;`<br>`src/app/api/users/[id]/route.ts:22-24` — `if (body.personal) update.personal = body.personal;` / `if (body.vectors) update.vectors = body.vectors;`<br>`src/app/api/match/feed/route.ts:68-75` — `const s = score(distance(myVec, pickVec(u)));` / `score: s,` |
| `preferences.desiredAgeRange/min/max` и `preferences.maxDistanceKm` | `User.preferences` | `POST /api/users` или `PUT /api/users/[id]` (если `body.preferences`) | Profile summary → `matching.filters` → UI `PreferencesCard` | `src/models/User.ts:19-22` — `preferences: {` / `maxDistanceKm: number;`<br>`src/app/api/users/route.ts:16` — `if (body.preferences) updateFields.preferences = body.preferences;`<br>`src/app/api/users/me/profile-summary/route.ts:110-112` — `const filters = {` / `age: [prefs?.desiredAgeRange?.min ?? 18, prefs?.desiredAgeRange?.max ?? 99],`<br>`src/app/(auth)/profile/page.tsx:107-110` — `<h2 className="text-lg font-semibold">Предпочтения партнёра</h2>` / `<PreferencesCard value={data.matching.filters} />` |
| `profile.onboarding.seeking.*` | `User.profile.onboarding.seeking` | Onboarding step 2 → `PATCH /api/users/[id]/onboarding` | `profile-summary` использует `valuedQualities` для фильтров | `src/models/User.ts:164-172` — `onboarding: {` / `valuedQualities: {`<br>`src/components/OnboardingWizard.tsx:66-77` — `status === 'seeking'` / `valuedQualities: qualities,`<br>`src/app/api/users/[id]/onboarding/route.ts:9-16` — `const body = await req.json();` / ``set[`profile.onboarding.${k}`] = v;``<br>`src/app/api/users/me/profile-summary/route.ts:113-114` — `valuedQualities: (user.profile?.onboarding?.seeking?.valuedQualities ?? []).slice(0, 3),` / `excludeTags: [] as string[],` |
| `profile.onboarding.inRelationship.*` | `User.profile.onboarding.inRelationship` | Onboarding step 2 → `PATCH /api/users/[id]/onboarding` | В коде не обнаружено | `src/models/User.ts:181-189` — `inRelationship: {` / `mainGrowthArea: {`<br>`src/components/OnboardingWizard.tsx:80-87` — `inRelationship: {` / `mainGrowthArea: growthArea,`<br>`src/app/api/users/[id]/onboarding/route.ts:9-16` — `const body = await req.json();` / ``set[`profile.onboarding.${k}`] = v;`` |
| `profile.matchCard` (`requirements/give/questions/isActive`) | `User.profile.matchCard` | `POST /api/match/card` из UI `/match-card/create` | Match feed использует `profile.matchCard.isActive` | `src/models/User.ts:86-122` — `const matchCardSchema = new Schema(` / `requirements: {`<br>`src/app/match-card/create/page.tsx:39-43` — `const res = await fetch(api('/api/match/card'), {` / `body: JSON.stringify({ userId: user.id, requirements, give, questions, isActive: true })`<br>`src/app/api/match/feed/route.ts:56-61` — `const candidates = await User.find(` / `'profile.matchCard.isActive': true,` |
| `passport.levelsByAxis/strongSides/growthAreas/values/boundaries` (profile-summary payload) | Вычисляется в `/api/users/me/profile-summary` из `user.vectors` и `user.passport` | `GET /api/users/me/profile-summary` | Profile overview UI (`AxisRadar`, блоки) | `src/app/api/users/me/profile-summary/route.ts:84-91` — `const strongSides: string[] = [];` / `if (neg >= 2) growthAreas.push(a);`<br>`src/app/api/users/me/profile-summary/route.ts:134-139` — `passport: {` / `boundaries: user.passport?.boundaries ?? [],`<br>`src/app/(auth)/profile/page.tsx:89-91` — `<section className="grid grid-cols-1 md:grid-cols-2 gap-4">` / `<AxisRadar levels={data.passport.levelsByAxis} />` |
| `readiness` / `fatigue` (user summary) | `UserExtra` в profile-summary (не в User model) | `GET /api/users/me/profile-summary` | Profile overview UI (`SummaryTiles`) | `src/app/api/users/me/profile-summary/route.ts:28-33` — `streak: { individual: number };` / `readiness: { score: number; updatedAt: Date };`<br>`src/app/api/users/me/profile-summary/route.ts:132-133` — `readiness: user.readiness ?? { score: 0, updatedAt: user.updatedAt },` / `fatigue: user.fatigue ?? { score: 0, updatedAt: user.updatedAt },` |

**Pair passport: as-is**
| Есть ли структура/DTO | Где формируется | Какие входы берёт | Какие выходы выдаёт | Хранение/кэш | Evidence (path:line + цитата ≤2 строки) |
|---|---|---|---|---|---|
| `Pair.passport` в модели (strongSides/riskZones/complementMap/levelDelta) | `buildPassport` в `/api/pairs/[id]/diagnostics` и `/api/match/confirm` | `User.vectors[axis].level/positives/negatives` | `{ strongSides, riskZones, complementMap, levelDelta, lastDiagnosticsAt? }` | Хранится в `Pair.passport` (DB), пересчитывается и записывается `updateOne` | `src/models/Pair.ts:21-27` — `passport?: {` / `lastDiagnosticsAt?: Date;`<br>`src/app/api/pairs/[id]/diagnostics/route.ts:20-29` — `const A = a.vectors[axis]; const B = b.vectors[axis];` / `const BcoversA = inter(B.positives, A.negatives);`<br>`src/app/api/pairs/[id]/diagnostics/route.ts:61-64` — `await Pair.updateOne(` / `{ $set: { 'passport.strongSides': passport.strongSides, 'passport.riskZones': passport.riskZones, 'passport.complementMap': passport.complementMap, 'passport.levelDelta': passport.levelDelta, 'passport.lastDiagnosticsAt': lastDiagnosticsAt } }` |
| DTO ответа diagnostics | `/api/pairs/[id]/diagnostics` | `pairId` (path), два User | `{ pairId, passport: { ... , lastDiagnosticsAt } }` | На лету + запись в `Pair` | `src/app/api/pairs/[id]/diagnostics/route.ts:43-56` — `const [ua, ub] = await Promise.all([` / `User.findOne({ id: pair.members[1] }).lean<UserType | null>(),`<br>`src/app/api/pairs/[id]/diagnostics/route.ts:66` — `return NextResponse.json({ pairId: id, passport: { ...passport, lastDiagnosticsAt } });` |
| DTO ответа pair summary | `/api/pairs/[id]/summary` | `pairId` (path) | `{ pair, currentActivity, suggestedCount, lastLike }` (pair включает passport) | Используется как read-API | `src/app/api/pairs/[id]/summary/route.ts:42-48` — `return NextResponse.json({` / `pair,` |

**Совместимость: as-is**
| Формула/логика | Evidence (path:line + цитата ≤2 строки) | Комментарий |
|---|---|---|
| Match score = `score(distance(vecA, vecB))`, где `score` нормирует 0..100 | `src/utils/calcMatch.ts:11-15` — `const raw  = 100 - (d / maxD) * 100;` / `return Math.min(100, Math.max(0, raw));`<br>`src/app/api/match/feed/route.ts:68-75` — `const s = score(distance(myVec, pickVec(u)));` / `score: s,` | Используется в `/api/match/feed` для выдачи кандидатов |
| Strong sides: пересечение `positives` или оба уровня ≥ `HIGH` | `src/app/api/pairs/[id]/diagnostics/route.ts:10-23` — `const HIGH = 2.0, LOW = 0.75, DELTA = 2.0;` / `const bothHigh = A.level >= HIGH && B.level >= HIGH;`<br>`src/app/api/pairs/[id]/diagnostics/route.ts:25-31` — `const pp = inter(A.positives, B.positives);` / `if (pp.length || bothHigh) strongSides.push({ axis, facets: pp });` | Плюс-логика на уровне пары |
| Risk zones: пересечение `negatives` или оба уровня ≤ `LOW` или `delta > DELTA`, severity по delta/nn | `src/app/api/pairs/[id]/diagnostics/route.ts:21-33` — `const bothLow  = A.level <= LOW  && B.level <= LOW;` / `if (nn.length || bothLow || delta > DELTA) {`<br>`src/app/api/pairs/[id]/diagnostics/route.ts:31-33` — `const severity: 1|2|3 = delta > DELTA + 1 ? 3 : (bothLow || nn.length >= 2 ? 2 : 1);` / `riskZones.push({ axis, facets: nn.length ? nn : [], severity });` | Минус-логика на уровне пары |
| Complement: пересечение `A.positives` с `B.negatives` и наоборот | `src/app/api/pairs/[id]/diagnostics/route.ts:27-35` — `const AcoversB = inter(A.positives, B.negatives);` / `if (AcoversB.length || BcoversA.length) complementMap.push({ axis, A_covers_B: AcoversB, B_covers_A: BcoversA });` | “Плюс на минус” хранится как `complementMap` |
| Level delta: `Math.abs(A.level - B.level)` при `delta > 0.01` | `src/app/api/pairs/[id]/diagnostics/route.ts:23-36` — `const delta    = Math.abs(A.level - B.level);` / `if (delta > 0.01) levelDelta.push({ axis, delta });` | Отдельная метрика различий |

**Совместимость: не обнаружено**
В коде не обнаружено: отдельная матрица совместимости/весов, явные правила “нейтрально” вне `strongSides/riskZones/complementMap`, пороги совместимости на уровне итогового match score (кроме clamp 0..100).

**UI→API маппинг**
| Страница → компоненты | API вызовы | Данные | Evidence (path:line + цитата ≤2 строки) |
|---|---|---|---|
| `/(auth)/profile` → `AxisRadar`, `SummaryTiles`, `PreferencesCard` | `GET /api/users/me/profile-summary?userId=...` | `passport.levelsByAxis`, `metrics`, `readiness/fatigue`, `matching.filters` | `src/app/(auth)/profile/page.tsx:45-50` — `fetch(api(`/api/users/me/profile-summary?userId=${user.id}`))` / `.then(r => r.json() as Promise<ProfileSummary>)`<br>`src/app/(auth)/profile/page.tsx:89-91` — `<section className="grid grid-cols-1 md:grid-cols-2 gap-4">` / `<AxisRadar levels={data.passport.levelsByAxis} />`<br>`src/app/(auth)/profile/page.tsx:83-86` — `<SummaryTiles` / `readiness={data.readiness}` |
| `/profile/(tabs)/matching` | `GET /api/users/me/profile-summary?userId=...` | `matching.inboxCount/outboxCount` | `src/app/profile/(tabs)/matching/page.tsx:18-23` — `fetch(api(`/api/users/me/profile-summary?userId=${user.id}`))` / `setInbox(Number(d?.matching?.inboxCount ?? 0));` |
| `/pair` → Pair profile | `GET /api/pairs/me` → `GET /api/pairs/{id}/summary` | `pair.passport.*`, `lastLike.matchScore` | `src/app/pair/page.tsx:60-78` — `fetch(api(`/api/pairs/me?userId=${user.id}`))` / `const res = await fetch(api(`/api/pairs/${id}/summary`));`<br>`src/app/pair/page.tsx:216-224` — `{(data.pair.passport?.strongSides ?? []).slice(0, 3).map((s, i) => (` / `{s.axis}: {s.facets.join(', ')}`<br>`src/app/pair/page.tsx:258-260` — `Скор: <b>{Math.round(data.lastLike.matchScore)}%</b>` / `{data.lastLike.updatedAt &&` |
| `/pair/[id]/diagnostics` | `GET /api/pairs/{id}/diagnostics` | `passport.riskZones/strongSides/complementMap/levelDelta` | `src/app/pair/[id]/diagnostics/page.tsx:42-45` — `const res = await fetch(api(`/api/pairs/${pairId}/diagnostics`));` / `const d = await res.json();`<br>`src/app/pair/[id]/diagnostics/page.tsx:85-93` — `{passport.riskZones?.length ? passport.riskZones.map((r, i) => (` / `facets: {r.facets.join(', ')}` |
| `/search` → Candidate feed | `GET /api/match/feed?userId=...`; guard: `/api/pairs/me`, `/api/match/card` | кандидаты `score`, match-card presence | `src/app/search/page.tsx:35-38` — `fetch(api(`/api/pairs/me?userId=${user.id}`))` / `fetch(api(`/api/match/card?userId=${user.id}`))`<br>`src/app/search/page.tsx:71-73` — `fetch(api(`/api/match/feed?userId=${user.id}`))` / `.then((items: Candidate[]) => setList(items ?? []))` |
| `/match/inbox` | `GET /api/match/inbox?userId=...` | inbox rows (`matchScore`, `status`, `peer`) | `src/app/match/inbox/page.tsx:104-114` — `const res = await fetch(api(`/api/match/inbox?userId=${user.id}`), { signal: ac.signal });` / `const data = (await res.json()) as Row[];` |
| `/match-card/create` | `GET /api/match/card?userId=...`, `POST /api/match/card` | `requirements/give/questions/isActive` | `src/app/match-card/create/page.tsx:22-27` — `fetch(api(`/api/match/card?userId=${user.id}`))` / `if (card?.requirements?.length === 3) router.replace('/search');`<br>`src/app/match-card/create/page.tsx:39-43` — `const res = await fetch(api('/api/match/card'), {` / `body: JSON.stringify({ userId: user.id, requirements, give, questions, isActive: true })` |

**Evidence**
Все доказательства приведены в столбцах Evidence таблиц выше.
